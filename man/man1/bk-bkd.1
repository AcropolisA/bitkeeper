.so ../bk-macros
.TH "bk bkd" 1 20%E% "\*(BC" "\*(UM"
.SH NAME
bk bkd \- the \*(BK daemon
.SH SYNOPSIS
.Bc bk bkd [\-CdDhiR] [more opts]
.SH DESCRIPTION
.LP
The \*(BK daemon, bkd, is used to synchronize and query repositories.
It is usually run in one of three ways:
.TP 4
a)
automatically started when accessing a remote repository via rsh, ssh, and/or
the file system;
.tp
b)
automatically started via ssh as a login shell;
.tp
c)
manually started as a long running stand-alone daemon.
.LP
The method used depends on how the remote repository is named.
See 
.B bk help url
for details on the naming syntax.
.LP
The stand-alone daemon method has no security, other than the
ability to run in read-only mode and/or the ability to limit chdir.
If security is a requirement, use 
.B ssh
to get to the daemon.  See below for information on
configuring the daemon as a login shell.
.SH "ANONYMOUS ACCESS"
.LP
The most common use of the stand-alone daemon is for anonymous access
to a repository.  To provide read-only, anonymous access, you can run:
.DS
bk bkd \-d \-xpush
.DE
.LP
This will allow anyone to read (but not write) all repositories at or below
the directory in which the bkd was started.
.LP
If you want to export a single repository, pick a port number, and 
do this:
.DS
cd /u/linux
bk bkd \-d \-p5555 \-xcd \-xpush
.DE
.LP
This says to run in daemon mode, bind to port 5555, and disallow the
"cd" and "push" commands.  By disallowing the "cd" command, the daemon
at port 5555 is tied to the repository in the current working directory
(bkd needs to be run at the root of the repository).  By disallowing the
"push" command, the repository is protected from updates.
.LP
Clients can get to this repository by using the BK URLs of
.DS    
bk://host.domain:5555
http://host.domain:5555
.DE
.br
i.e.,
.DS
$ bk clone bk://host.domain:5555 my_tree
.DE
Use the http URLs allows access through most firewalls.  \*(BK supports
accessing repositories through http proxies, including authenticated
proxies.
.SH SECURED ACCESS VIA SSH
Secure access is provided via 
.BR ssh .
There two ways to invoke 
.BR ssh :
.tp 4
a)
when the repository is specified in this form: 
[\c
.ARGc user @]
.ARGc host :
.ARG pathname ,
.B ssh
will be called to run
.B bk bkd
on the remote host.  When the client command completes, the 
.B ssh 
connection is broken and the 
.B bkd
daemon goes away.
.tp
b)
when the repository is specified in this form: 
.Bc bk://user@host[
.ARG pathname \fB]\fR,
.B ssh
will be called to remote login to 
.B host
and will expect that the login shell is the \*(BK daemon.
.LP
.SS BKD LOGIN SHELL
On Red Hat Linux, the following steps are necessary to add a \*(BK 
daemon login shell:
create a simple shell script, call it 
.BR bkd , 
put it someplace like 
.BR /usr/libexec/bitkeeper/bkd ,
add the full path to the script in 
.BR /etc/shells ,
and add a user with that path as their shell.
.LP
An example 
.B bkd
shell script which works for us is:
.DS
#!/bin/sh
exec bk bkd -C -xcd
.DE
.LP
.B Note:
using the bkd as a login shell when accessing the system using
.BR rsh 
is unsupported for two reasons: 
.B rsh 
is insecure and there is a bug which prevents correct operation 
in this configuration.
.SH BK/WEB
The bkd is a self contained http server which provides the optional
BK/Web feature of \*(BK.  In order for this feature to work, one of
two things must be true:
.TP 4
a)
The bkd must be run at the root of a repository which contains a 
commercial license which has the BK/Web option enabled;
.tp
b)
The bkd must be run on a machine which is directly connected to the
Internet and the
.BR clone
and
.BR pull
commands cannot be disabled.
.SH WINDOWS BASED BKD
.LP
At this time, bkd support on win32 is as a stand-alone daemon only
and is restricted to one bkd service per host.  To initially start the
bkd service:
.DS
open a cmd shell
bk bkd -p<port>
.DE
.LP
Once the bkd has been started, the service manager can be used
to stop and start the bkd service.  On Win2K:
.DS
start->control\ panel->Administrative\ Tools->services
right click on the bkd service
click stop/start button
.DE
On WinNT:
.DS
start->control\ panel->services
click the start/stop button
.DE
To remove the bkd service from the service manager:
.DS
open a cmd shell
bk bkd -R
.DE
.LP
Once launched, upon reboot, the bkd service is automatically re-started.
To disable this feature on Win2K:
.DS
right click on BitKeeper service
select properties
change "startup type" to disable
.DE
On WinNT:
.DS
go to start->control\ panel->services->BitKeeper\ service->startup
select disable
.SH OPTIONS
.TP 1i
.B \-C
This option provides a slightly more secure mode of
operation in that the bkd will refuse to change directories up out of 
the directory in which it was started.
.tp
.B \-d
Run as a daemon.  Implies \-C.
.tp
.B \-D
Debug mode, do not fork and run in the background.
.tp
.B \-h
Make bkd print http headers on all outgoing bk push, bk pull,
and bk clone messages.  Use when bkd is called from a cgi script.
.tp
.OPTreq \-l log
Log accesses in 
.ARG log ;
if
.ARG log
is not specified, then log to stderr.
.tp
.OPTreq \-P pfile
Write the pid of daemon process into this file at startup.
.tp
.OPTreq \-p port
Specify an alternative port.  The default port is 0x3962 (aka 14690).
This option implies \-d.
.tp
.OPTreq \-g gid
Attempt to run with group id
.ARG gid 
(POSIX compatible systems only).
.tp
.OPTreq \-u uid
Attempt to run with user id
.ARG uid
(POSIX compatible systems only).
.tp
.OPTreq \-x cmd
Exclude 
.ARG cmd
from the allowed command list.  The list of commands which may be excluded
currently are:
abort,
cd,
check,
clone,
get,
httpget,
pull,
push,
pwd,
rclone,
rootkey,
status,
synckeys,
and
version.
.SH WINDOWS ONLY OPTIONS
.TP 1i
.B \-R
Shutdown the bkd service.
.SH EXAMPLES
.LP
We use the following in 
.B /var/bitkeeper/repositories
to provide anonymous read only access to some \*(BK repositories.  
.DS
#----------------------\ cut\ here\ --------------------------
/bk -C \-u99 \-g10
#----------------------\ cut\ here\ --------------------------
.DE
.LP
The init script shown below can be generated with a 
.DS
$ bk getmsg bitkeeper.init
.DE
We use the it in
.BR /etc/rc.d/init.d/bitkeeper
to start up \*(BK on bitkeeper.com (a Red Hat based Linux system):
.DS
#----------------------\ cut\ here\ --------------------------
#!/bin/sh
#
# chkconfig: 2345 24 84
# description: BitKeeper server for work

# Source networking configuration.
if [ \-f /etc/sysconfig/network ]
then	. /etc/sysconfig/network

	# Check that networking is up.
	[ ${NETWORKING} = "no" ] && exit 0
fi
[ \-x /usr/bin/bk ] || exit 0
VAR=/var/bitkeeper

case "$1" in
    start_msg)	echo "Start BitKeeper daemons"
		;;
    stop_msg)	echo "Stop BitKeeper daemons"
		;;
    restart)	$0 stop
		$0 start
		;;
    start)	cd $VAR || exit 1
		test \-f repositories || {
			echo Nothing advertised
			exit 0
		}
		while read dir opts
		do	(
			cd $dir || exit 1
			F=`basename $dir`
			CMD="bk bkd \-d $opts \-l$VAR/log.$F \-P$VAR/pid.$F"
			eval $CMD 2>> $VAR/errors
			echo Started $CMD in $dir
			)
		done < repositories
	    	;;

    stop)	
		cd $VAR || exit 1
		echo Shutting down BitKeeper daemons
		for i in pid.*
		do	kill `cat $i`
			rm $i
		done
		;;

    status)	cd $VAR || exit 1
		for i in pid.*
		do	echo This pid should be running: `cat $i`
		done
		ps \-axf | grep bkd
		
		;;

    *)		echo "Usage: bitkeeper {start|stop}"
    		exit 1
		;;
esac

exit 0
#----------------------\ cut\ here\ --------------------------
.DE
.SH BUGS
Needs 
.B ssh
to provide access controlled, authenticated users.
One could argue that this is code reuse rather than a bug.
.LP
\*(BM
does not ship
.B ssh
since it is export controlled.
.LP
On Windows the bkd does not work when started from a network drive.
.LP
On Windows the bkd does not work when started from a subst'ed drive.
.SH "SEE ALSO"
.SA parent
.SA url
.SA Howto-bkd 1
.\" help://anonymous
.\" help://deamon
.\" help://daemon
.\" help://demon
.\" help://security
.\" help://secure
.\" help://bkweb
.\" help://bk/web
.SH CATEGORY
.B Repository
.br
.B Admin
