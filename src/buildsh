#/bin/sh

# This is a script that creates a bootstrap MSYS environment that
# can be used when building bk.
#
# It is assumed to be run like this:
#    `bk bin`/gnu/bin/sh buildsh
#
# so it get executed by the MSYS shell from an existing bk installation.
# We can't assume that that MSYS shell is the correct version so the first
# this we do a build a current MSYS environment in tmp/build and then
# spawn a new windows that is running the new MSYS shell.  BK can then
# be built and tested in that shell

# restrict path do only things of interest
PATH=/bin	# for sed
MSYSWINDIR=$(echo $WINDIR | sed 's,\(.\):\\,/\1/,')
PATH=/bin:$MSYSWINDIR/system32:$MSYSWINDIR
# Add bk to end of PATH
BK_PATH=$(mount | tr 'A-Z' 'a-z' | sed -ne 's,\(.\):,/\1,' -e 's,\\,/,g' -e 's,/gnu/bin,,' -e 's, on /bin type.*,,p') 
PATH=$PATH:$BK_PATH

mkdir -p /c/build
D=/c/build/buildenv
echo removing old buildenv
rm -rf $D || {
	echo cannot remove $D
	exit 1
}

# build and install new msys
(cd win32; make MSYSBIN=$D msys)

W32TOOLS=/c/build/win32tools
test -d $W32TOOLS || bk clone bk://data.bitmover.com/win32tools $W32TOOLS
bk sfiles -Ug $W32TOOLS | bk get -S -

# build mingw
echo extracting MinGW
mkdir $D/mingw
tar -C$D/mingw -xzf $W32TOOLS/binutils-2.13.90-20030111-1.tar.gz
tar -C$D/mingw -xzf $W32TOOLS/mingw-runtime-3.2.tar.gz
tar -C$D/mingw -xzf $W32TOOLS/gcc-core-3.3.1-20030804-1.tar.gz
tar -C$D/mingw -xzf $W32TOOLS/gcc-g++-3.3.1-20030804-1.tar.gz
tar -C$D/mingw -xzf $W32TOOLS/w32api-2.5.tar.gz

echo extract perl
tar -C$D -xzf $W32TOOLS/perl.tar.gz

echo extract groff
mkdir $D/groff
tar -C$D/groff -xzf $W32TOOLS/groff-1.19.1-alpha-bin.tar.gz

# create custom startup scripts with fixed PATH
rm -f $D/etc/profile
echo PATH=/bin:/mingw/bin:$BK_PATH:/perl/bin:/groff/bin:$MSYSWINDIR/system32:$MSYSWINDIR > $D/etc/profile
echo HOME=`pwd` >> $D/etc/profile

WD=`cd $D; bk pwd -s`
echo "export GROFF_TMAC_PATH='$WD/groff/share/groff/site-tmac;$WD/groff/share/groff/1.19.1/tmac'" >> $D/etc/profile
echo "export GROFF_FONT_PATH=$WD/groff/share/groff/1.19.1/font" >> $D/etc/profile
echo "export GRAP_DEFINES=$WD/groff/share/grap/grap.defines" >> $D/etc/profile

# setup mountpoints
mkdir -p $D/build
rm -f $D/etc/fstab
echo "c:/build /build" > $D/etc/fstab

echo PS1=\'BUILD \\W \\$ \' >> $D/etc/profile
cp $D/bin/sh.exe $D/bin/bash.exe

# start new cmd shell window with new shell
#   XXX probably fails on win98
cmd //c start $D/bin/sh --login
