HERE	:= $(shell pwd)
OSTYPE	:= $(shell bash -c 'echo $$OSTYPE')
BKROOT	:= $(shell bk -P root)

CC := gcc
LD := gcc
STRIP := strip
export CC LD

# The Tk version is tied to the Tcl version so you only need to change TCL
TCLVERSION := 8.6

# Machines on which we disable XFT
NO_XFT := netbsd4.bitmover.com	\
	netbsd4-64.bitmover.com	\
	freebsd4.bitmover.com	\
	sco.bitmover.com	\
	netbsd.bitmover.com	\
	aix5.bitmover.com	\
	sunx86.bitmover.com	\
	hp11.bitmover.com	\
	macos103.bitmover.com	\
	hp-ia64.bitmover.com	\
	sun.bitmover.com

ifeq "$(OSTYPE)" "msys"
	S := win
	EXE := .exe
	SO := .dll
	STRIP := true
	XFTSUPPORT :=
	SHARED := --enable-shared
	PCRE_OBJ:= bin/tcl$(subst .,,$(TCLVERSION)).dll
else
	S := unix
	EXE :=
	SO  := .so
	XSSSUPPORT := --disable-xss
	ifeq (,$(findstring $(shell bk gethost -r), $(NO_XFT)))
		XFTSUPPORT := --enable-xft
	endif
	SHARED := --disable-shared
	PCRE_OBJ:= bin/tclsh
	ifeq "$(shell uname)" "Darwin"
		AQUA := 1
		BKAPP=bin/BitKeeper.app
		SO := .dylib
		SINGLE_MODULE := "LDFLAGS=-single_module"
		ENABLE_64BIT=
		ifeq "$(shell uname -p)" "G5"
			ENABLE_64BIT=--enable-64bit
		endif
		ifeq (10.,$(findstring 10.,$(shell uname -r)))
			CC := cc -m32
			LD := $(CC)
			export CC LD
		endif
	else
		ifeq "$(shell uname -m)" "x86_64"
			ENABLE_64BIT=--enable-64bit
		endif
	endif
	# No rpath on freebsd 2.2.8
	ifeq "$(shell uname -r)" "2.2.8-RELEASE"
		SHARED := $(SHARED) --disable-rpath
	endif
endif

ifdef	DEBUG_TCL
	SYMBOLS	:= --enable-symbols=all
endif

ifdef	Q
	QUIET=-q
endif

ifeq "$(TCLVERSION)" "8.4"
DDEVERSION := 1.2
REGVERSION := 1.1
TCLBUILD := /build/tcl-$(USER)/Tcl.framework
TKBUILD  := /build/tk-$(USER)/Tk.framework
WISHPATH := /build/tk-$(USER)/BitKeeper.app
EXTENSIONS :=
AQUAEXTENSIONS :=
else
# For Tcl/Tk 8.5
DDEVERSION := 1.3
REGVERSION := 1.2
TKTABLE := Tktable2.10

LIBTKTABLE := lib$(TKTABLE)$(SO)
TREECTRL := treectrl2.2.9
LIBTREECTRL := libtreectrl2.2$(SO)
BWIDGET := BWidget1.8
TCLBUILD := ../build/tcl/Tcl.framework
TKBUILD  := ../build/tk/Tk.framework
WISHPATH := build/tk/Wish.app
EXTENSIONS := lib/$(TKTABLE)/$(LIBTKTABLE) \
	      lib/$(TREECTRL)/$(LIBTREECTRL) \
	      lib/$(BWIDGET)/pkgIndex.tcl \
	      lib/Tkcon/pkgIndex.tcl
AQUAEXTENSIONS := $(BKAPP)/Contents/lib/$(TKTABLE)/$(LIBTKTABLE) \
		  $(BKAPP)/Contents/lib/$(TREECTRL)/$(LIBTREECTRL) \
		  $(BKAPP)/Contents/lib/$(BWIDGET)/pkgIndex.tcl \
		  $(BKAPP)/Contents/lib/Tkcon/pkgIndex.tcl
endif

LIBTOMCRYPT=$(BKROOT)/src/tomcrypt/libtomcrypt.a
TOMMATH=$(BKROOT)/src/tommath
LIBPCRE=$(BKROOT)/src/gui/tcltk/pcre/local/lib/libpcre.a

all: version.sh ../../tclkey.h
	$(if $(Q),@echo Building Tcl/Tk,)
	-$(Q)rm -rf bin lib share
	$(Q)TCLVER=`./version.sh`; \
	if [ -n "$$TCLVER" -a -f "$$TCLVER" -a -z "$$FORCE_REBUILD" ]; \
	then	gunzip < "$$TCLVER" | tar -xf -; true; \
	else	unset CC LD CCXTRA CFLAGS MAKEFLAGS; \
		$(MAKE) Q=$(Q) bin/tclsh$(EXE) || exit 1; \
		$(MAKE) Q=$(Q) bin/bkgui$(EXE) $(EXTENSIONS) || exit 1; \
		test "X$(AQUA)" = X && exit 0; \
		$(MAKE) Q=$(Q) $(BKAPP)/Contents/MacOS/BitKeeper || exit 1; \
		$(MAKE) Q=$(Q) $(AQUAEXTENSIONS) || exit 1; \
	fi
	$(Q)$(MAKE) verify
	$(Q)$(MAKE) rm_doc
	$(Q)$(MAKE) install

srcs: pcre/configure \
	tcl/$S/configure \
	tk/$S/configure \
	tktable/configure \
	tktreectrl/configure \
	lib/$(BWIDGET)/pkgIndex.tcl \
	lib/Tkcon/pkgIndex.tcl

src-check: src-check.sh
	@make -s srcs
	@./src-check.sh

tcl/$S/Makefile: tcl/$S/configure $(LIBPCRE) Makefile
	$(if $(Q),@echo Configuring Tcl,)
	$(Q)cd tcl/$S; \
	./configure $(QUIET) \
	    --disable-info-body --enable-pcre=default --with-pcre=../../pcre/local \
	    $(ENABLE_64BIT) $(SHARED) $(SYMBOLS) \
	    --with-tommath=$(TOMMATH)

tk/$S/Makefile: tk/$S/configure Makefile
	$(if $(Q),@echo Configuring Tk,)
	$(Q)cd tk/$S; \
	./configure $(QUIET) \
	    $(ENABLE_64BIT) $(XSSSUPPORT) $(XFTSUPPORT) $(SHARED) $(SYMBOLS)

# Use the <dir>/ChangeLog file as a marker that the file has been populated
CHANGELOGS =  \
	tcl/ChangeLog \
	tk/ChangeLog \
	tktable/ChangeLog \
	tktreectrl/ChangeLog \
	bwidget/ChangeLog \
	pcre/ChangeLog \
	tkcon/ChangeLog

$(CHANGELOGS):
	$(if $(Q), @echo Cloning TclTk repos,)
	$(Q) BK_CONFIG='checkout:get!' bk here add $(QUIET) TCLTK || \
	     BK_CONFIG='checkout:get!' bk here add $(QUIET) \
		-@bk://data.bitmover.com$$_BUILD_PORT/bk TCLTK
	$(Q) bk get -S $(CHANGELOGS)

# fetch tcl subdirectory if needed
tcl/$S/configure: tcl/ChangeLog
	$(Q)(cd tcl && bk -Ur get -qS)

# fetch tk subdirectory if needed
tk/$S/configure: tk/ChangeLog
	$(Q)(cd tk && bk -Ur get -qS)

pcre: $(LIBPCRE)

$(LIBPCRE): pcre/Makefile Makefile
	$(if $(Q), @echo Building PCRE,)
	$(Q)(cd pcre && $(MAKE) && \
	    $(MAKE) prefix= exec_prefix= DESTDIR="`pwd`"/local/ \
		libdir=lib bindir=bin includedir=include install)

pcre/Makefile: pcre/configure Makefile
	$(if $(Q), @echo Configuring PCRE,)
	$(Q)(cd pcre && \
	    ./configure $(QUIET) --disable-cpp --disable-shared  --prefix=)

pcre/configure: Makefile pcre/ChangeLog
	$(Q)(cd pcre && bk -Ur get -qS)

# fetch tktable subdirectory if needed
tktable/configure: tktable/ChangeLog
	$(Q)(cd tktable && bk -Ur get -qS)

# Tktable libs
lib/$(TKTABLE)/$(LIBTKTABLE): tktable/configure bin/bkgui$(EXE)
	cd tktable ; \
	test -f Makefile -a "X$(AQUA)" != X && { \
		$(MAKE) distclean ; \
	}; \
	test -f Makefile || { \
		./configure $(QUIET) --with-tcl=../tcl/$S --with-tk=../tk/$S \
			--with-tclinclude=../tcl/generic \
			--with-tkinclude=../tk/generic \
			--disable-threads $(ENABLE_64BIT) $(SYMBOLS) ; \
	}; \
	$(MAKE) $(SINGLE_MODULE) \
		prefix= exec_prefix= DESTDIR=../ \
		libdir=lib bindir=bin install

$(BKAPP)/Contents/lib/$(TKTABLE)/$(LIBTKTABLE): tktable/configure
	cd tktable; \
	test -f Makefile -a "X$(AQUA)" != X && { \
		$(MAKE) distclean ; \
	}; \
	test -f Makefile || { \
		./configure $(QUIET) \
		    --with-tcl=$(TCLBUILD) \
		    --with-tk=$(TKBUILD) \
		    --with-tclinclude=$(TCLBUILD)/Headers \
		    --with-tkinclude=$(TKBUILD)/Headers ; \
	}; \
	$(MAKE) prefix= exec_prefix= DESTDIR=../$(BKAPP)/Contents/ \
	    libdir=lib bindir=Resources install

# fetch tktreectrl subdirectory if needed
tktreectrl/configure: tktreectrl/ChangeLog
	$(Q)(cd tktreectrl && bk -Ur get -qS)

# TkTreeCtrl libs
lib/$(TREECTRL)/$(LIBTREECTRL): tktreectrl/configure bin/bkgui$(EXE)
	cd tktreectrl ; \
	test -f Makefile -a "X$(AQUA)" != X && { \
		$(MAKE) distclean ; \
	}; \
	test -f Makefile || { \
		./configure $(QUIET) --with-tcl=../tcl/$S --with-tk=../tk/$S \
			--with-tclinclude=../tcl/generic \
			--with-tkinclude=../tk/generic \
			--disable-threads $(ENABLE_64BIT) $(SYMBOLS) ; \
	}; \
	$(MAKE) prefix= exec_prefix= DESTDIR=../ \
		libdir=lib bindir=bin install

$(BKAPP)/Contents/lib/$(TREECTRL)/$(LIBTREECTRL): tktreectrl/configure
	cd tktreectrl; \
	test -f Makefile -a "X$(AQUA)" != X && { \
		$(MAKE) distclean ; \
	}; \
	test -f Makefile || { \
		./configure $(QUIET) \
		    --with-tcl=$(TCLBUILD) \
		    --with-tk=$(TKBUILD) \
		    --with-tclinclude=$(TCLBUILD)/Headers \
		    --with-tkinclude=$(TKBUILD)/Headers ; \
	}; \
	$(MAKE) prefix= exec_prefix= DESTDIR=../$(BKAPP)/Contents/ \
	    libdir=lib bindir=Resources install

lib/$(BWIDGET)/pkgIndex.tcl: bwidget/ChangeLog
	$(Q)cd bwidget; bk -Ur get -qS
	$(if $(Q), @echo Installing BWidget,)
	$(Q)mkdir -p lib/$(BWIDGET)/lang
	$(Q)mkdir -p lib/$(BWIDGET)/images
	$(Q)cp bwidget/*.tcl lib/$(BWIDGET)
	$(Q)cp bwidget/lang/*.rc lib/$(BWIDGET)/lang
	$(Q)cp bwidget/images/*.gif lib/$(BWIDGET)/images
	$(Q)cp bwidget/images/*.xbm lib/$(BWIDGET)/images

$(BKAPP)/Contents/lib/$(BWIDGET)/pkgIndex.tcl: lib/$(BWIDGET)/pkgIndex.tcl
	test -d $(BKAPP)/Contents/lib || mkdir $(BKAPP)/Contents/lib
	cp -fRPH lib/$(BWIDGET) $(BKAPP)/Contents/lib

lib/Tkcon/pkgIndex.tcl: tkcon/ChangeLog
	cd tkcon; bk -Ur get -qS
	$(if $(Q), @echo Installing TkCon,)
	$(Q)mkdir -p lib/Tkcon
	$(Q)cp tkcon/tkcon.tcl lib/Tkcon
	$(Q)cp tkcon/pkgIndex.tcl lib/Tkcon

$(BKAPP)/Contents/lib/Tkcon/pkgIndex.tcl: lib/Tkcon/pkgIndex.tcl
	test -d $(BKAPP)/Contents/lib || mkdir $(BKAPP)/Contents/lib
	cp -fRPH lib/Tkcon $(BKAPP)/Contents/lib

$(BKAPP)/Contents/lib/GetOpts/pkgIndex.tcl: lib/GetOpts/pkgIndex.tcl
	test -d $(BKAPP)/Contents/lib || mkdir $(BKAPP)/Contents/lib
	cp -fRPH lib/GetOpts $(BKAPP)/Contents/lib

rm_doc: FORCE
	rm -rf lib/$(TKTABLE)/html \
	    lib/$(TREECTRL)/htmldoc
	if [ "X$(AQUA)" != X ]; \
	then \
	    rm -rf \
		$(BKAPP)/Contents/lib/$(TKTABLE)/html \
		$(BKAPP)/Contents/lib/$(TREECTRL)/htmldoc \
		$(BKAPP)/Contents/man ; \
	fi

install: ./version.sh
	find bin lib -type d -print | xargs chmod ug+w
	rm -rf ../bin ../lib
	tar cf - bin lib | (cd .. && tar xf -)
	-TCLVER=`./version.sh`; \
	if [ -n "$$TCLVER" -a \! -f "$$TCLVER" ]; \
	then	test -d /build/obj || { \
			mkdir /build/obj; \
			chmod 777 /build/obj; \
		}; \
		tar cf - bin lib | gzip > "$$TCLVER"; \
		chmod 666 "$$TCLVER"; \
	fi

bin/tclsh$(EXE): tcl/$S/Makefile
	rm -rf bin/tclsh$(EXE) lib/tcl*
	cd tcl/$S && \
	$(MAKE) Q=$(Q) prefix= exec_prefix= INSTALL_ROOT=../.. \
	    XLIBS="$(LIBTOMCRYPT)" \
	    l-tests install-binaries install-libraries
	if [ -x bin/tclsh$(TCLVERSION)$(EXE) ] ; then \
		mv bin/tclsh$(TCLVERSION)$(EXE) bin/tclsh$(EXE) ; \
	fi
	if [ ! -x bin/tclsh$(EXE) ] ; then \
		echo Could not find bin/tclsh$(EXE) ; \
	fi
	if [ -d usr/local/lib/dde$(DDEVERSION) ] ; then \
		mv usr/local/lib/dde$(DDEVERSION) lib/tcl$(TCLVERSION) ; \
	fi
	if [ -d usr/local/lib/reg$(REGVERSION) ] ; then \
		mv usr/local/lib/reg$(REGVERSION) lib/tcl$(TCLVERSION); \
	fi
	rm -rf include usr lib/tcl$(TCLVERSION)/tcltest*
	if [ -z "$(DEBUG_TCL)" ] ; then \
		$(STRIP) bin/tclsh$(EXE) ; \
	fi
	strings -a $(PCRE_OBJ) | grep -q "pcre_exec"

bin/bkgui$(EXE): tk/$S/Makefile bin/tclsh$(EXE)
	rm -rf bin/bkgui$(EXE) lib/tk*
	cd tk/$S && \
	$(MAKE) prefix= exec_prefix= INSTALL_ROOT=../.. \
	    XLIBS="$(LIBTOMCRYPT) $(LIBPCRE)" \
	    install-binaries install-libraries
	rm -rf include usr lib/tk*/images
	cd lib/tcl$(TCLVERSION)/encoding/; \
	    mkdir tmp; \
	    mv ascii.* cp1252.* iso8859-1.* iso8859-2.* macRoman.* tmp; \
	    rm -f *.enc; \
	    mv tmp/* .; \
	    rmdir tmp
	mv bin/wish* bin/bkgui$(EXE)
	if [ -z "$(DEBUG_TCL)" ] ; then \
		$(STRIP) bin/bkgui$(EXE); \
	fi

mkapp: FORCE
	-bk get mkapp

bin/BitKeeper.app/Contents/MacOS/BitKeeper: bin/tclsh$(EXE) bin/bkgui$(EXE) mkapp
	$(MAKE) -C tcl/macosx XLIBS="$(LIBTOMCRYPT)" \
	    EXTRA_CONFIGURE_ARGS="--with-bk=$(BKROOT) --disable-info-body \
	    --enable-pcre=default --with-pcre=../../../pcre/local \
	    --with-tommath=$(TOMMATH)" embedded
	$(MAKE) -C tk/macosx XLIBS="$(LIBTOMCRYPT) $(LIBPCRE)" \
	    EXTRA_CONFIGURE_ARGS="--with-bk=$(BKROOT)" embedded
	./mkapp BitKeeper 1.0 BkAp "BitMover, Inc" com.bitmover.bk "$(WISHPATH)"

clean-obj: FORCE
	-test -d tcl && cd tcl/$S && test -f Makefile && $(MAKE) distclean
	-test -d tk && cd tk/$S && test -f Makefile && $(MAKE) distclean
	-test -d tktable && cd tktable && test -f Makefile && $(MAKE) distclean
	-test -d tktreectrl && cd tktreectrl && test -f Makefile && $(MAKE) distclean
	-test -d pcre && cd pcre && { \
		test -f Makefile && $(MAKE) distclean; \
		rm -rf local; \
	}
	-@$(MAKE) clean-config

clean-config: FORCE
	-for i in Makefile config.cache config.log tclConfig.sh config.status; \
	do	rm -f tcl/$S/$$i tk/$S/$$i; \
	done

clean: clean-obj FORCE
	rm -rf bin lib man build include usr share
	-rm -rf build

clobber: clean FORCE
	-bk sfiles -r | bk clean -	# clean here and all subrepos

rmcache: version.sh
	rm -f `./version.sh`
	bk clean -q version.sh

test:
	test -d tk && cd tk/$S && $(MAKE) test

verify: FORCE
	test -d lib/$(TKTABLE) || exit 1
	test -d lib/$(TREECTRL) || exit 1
	test -f lib/$(BWIDGET)/pkgIndex.tcl || exit 1
	if [ "X$(AQUA)" != X ]; \
	then \
	    test -d $(BKAPP)/Contents/lib/$(TKTABLE) || exit 1 ; \
	    test -d $(BKAPP)/Contents/lib/$(TREECTRL) || exit 1 ; \
	    test -f $(BKAPP)/Contents/lib/$(BWIDGET)/pkgIndex.tcl \
		|| exit 1 ; \
	fi

FORCE:

.PHONY: all configure
