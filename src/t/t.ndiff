# Note in these tests we can't use cmpfiles as it will ignore \r's

dumpdiffs() {
	echo
	echo --- WANT ---
	cat WANT
	echo --- OD WANT ---
	od -a WANT
	echo --- GOT ---
	cat GOT
	echo --- OD GOT ---
	od -a GOT
}

echo $N Basic........................................................$NL
cd "$HERE"
echo a > A
echo b > B
cat >WANT <<EOF
1c1
< a
---
> b
EOF
bk ndiff A B > GOT && fail Expected diffs
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
echo OK

echo $N Test no newline at end of file...............................$NL
cat <<EOF >>A
A
B
C
D
EOF
cat <<EOF >B
A
1
B
D
EOF
echon "2" >> B
bk ndiff A B > GOT && fail Expected diffs
bk diff A B >WANT
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
echo OK

echo $N Test no newline makes it through.............................$NL
echo bar > A
echo bar > B
printf "foo\r" >> B
bk diff A B > WANT
bk ndiff A B > GOT
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
echo OK

echo $N Test no new line at end of file does not match other lines...$NL
cat <<EOF >A
A
B
C
2
D
EOF
cat <<EOF >B
A
EOF
printf "2" >> B
cat <<EOF > WANT
2,5c2
< B
< C
< 2
< D
---
> 2
\ No newline at end of file
EOF
bk ndiff --strip-trailing-cr A B > GOT
cmp -s WANT GOT || {
	dumpdiffs
	fail Different results
}
echo OK

echo $N Test our wacky --ignore-tailing-cr...........................$NL
echo a > A
printf "a\n\r" > B
bk diff --ignore-trailing-cr A B >WANT && fail
bk ndiff --ignore-trailing-cr A B >GOT && {
	dumpdiffs
	fail
}
cmp -s WANT GOT || {
	dumpdiffs
	fail Different results
}
echo a > A
echon a > B
bk diff --ignore-trailing-cr A B > WANT && fail
bk ndiff --ignore-trailing-cr A B > GOT && {
	dumpdiffs
	fail
}
cmp -s WANT GOT || {
	dumpdiffs
	fail Different results
}
printf "\ra\r\n" > A
printf "\ra\r\r\r\n" > B
bk diff --ignore-trailing-cr A B > WANT || fail $?
bk ndiff --ignore-trailing-cr A B > GOT || fail $?
cmp -s WANT GOT || {
	dumpdiffs
	fail Different results
}
printf 'data\r\n' > A
echo 'data' > B
bk diff --ignore-trailing-cr A B > WANT || fail $?
bk ndiff --ignore-trailing-cr A B > GOT || fail $?
cmp -s WANT GOT || {
	dumpdiffs
	fail Different results
}
echo 'data' > A
echo 'data' > B
printf 'last line\r\n' >> B
bk diff --ignore-trailing-cr A B > WANT && fail $?
bk ndiff --ignore-trailing-cr A B > GOT && fail $?
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
printf "bar\r\n" > A
printf "bar\r\nfoo\r" > B
bk diff --ignore-trailing-cr A B > WANT
bk ndiff --ignore-trailing-cr A B > GOT
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
printf "bar\r\n" > A
printf "bar\r\nfoo\r\n" > B
bk diff --ignore-trailing-cr A B > WANT
bk ndiff --ignore-trailing-cr A B > GOT
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
printf "a\nb\nc\r\r\r\r" > A
printf "a\n1\nc\r\r\r" > B
bk diff --ignore-trailing-cr A B > WANT
bk ndiff --ignore-trailing-cr A B >GOT
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
printf "a\r\nb\r\n" > A
printf "a\r\nb\r\nc\r\n" > B
bk diff --ignore-trailing-cr A B > WANT
bk ndiff --ignore-trailing-cr A B > GOT
cmpfiles WANT GOT
bk ndiff --strip-trailing-cr A B > GOT
cmpfiles WANT GOT
echo OK

echo $N Test binary detection........................................$NL
echo baseline > A
cp A B
echo 'There is a null right here X>' | tr X '\000' >> B
echo "" >> B
echo and another line after that >> B
bk diff --ignore-trailing-cr A B > WANT && fail $?
bk ndiff --ignore-trailing-cr A B > GOT && fail $?
cmp -s WANT GOT || {
	dumpdiffs
	fail Different results
}
echo OK


echo $N Asymetric test...............................................$NL
cat > A <<EOF
#
#
#
#

#
#
#
#



EOF
cat > B <<EOF

#
EOF
cat > WANT <<EOF
1,4d0
< #
< #
< #
< #
7,12d2
< #
< #
< #
< 
< 
< 
EOF
bk ndiff A B > GOT && fail Expected diffs
cmp -s WANT GOT || fail Different results
echo OK

echo $N Test ndiff -p................................................$NL
cat <<EOF > A
#include <stdio.h>

int
main(int ac, char **av)
{
	int a, b, c;
	int d, e, f;

	/* this is where code would go */
	return (0);
}
EOF
cat <<EOF > B
#include <stdio.h>

int
main(int ac, char **av)
{
	int a, b, c;
	int d, e, f;

	/* this is where code would go */
	return (1);
}
EOF
cat <<EOF > WANT
--- A
+++ B
@@ -7,5 +7,5 @@ main(int ac, char **av)
 	int d, e, f;
 
 	/* this is where code would go */
-	return (0);
+	return (1);
 }
EOF
bk ndiff -up A B | sed -e 's/^--- A.*/--- A/g' -e 's/^+++ B.*/+++ B/g' > GOT
cmpfiles WANT GOT
cat <<EOF > WANT
--- A
+++ B
@@ -10 +10 @@ main(int ac, char **av)
-	return (0);
+	return (1);
EOF
bk ndiff -u0p A B | sed -e 's/^--- A.*/--- A/g' -e 's/^+++ B.*/+++ B/g' > GOT
cmpfiles WANT GOT
echo OK

echo $N Try -p again but with a longer function......................$NL
sed 's/main/huge_function_name_more_than_40_characters_long/g' A > LA
sed 's/main/huge_function_name_more_than_40_characters_long/g' B > LB
cat <<EOF > WANT
--- LA
+++ LB
@@ -7,5 +7,5 @@ huge_function_name_more_than_40_characte
 	int d, e, f;
 
 	/* this is where code would go */
-	return (0);
+	return (1);
 }
EOF
bk ndiff -up LA LB | sed -e 's/^--- LA.*/--- LA/g' \
		-e 's/^+++ LB.*/+++ LB/g' > GOT
cmp -s WANT GOT || fail Different results
echo OK

echo $N Test -p with multiple functions..............................$NL
cat <<EOF > A
int
foo(int arg)
{
	/* code */
}








int
bar(int arg)
{



	/* other code */
}
EOF
cat <<EOF > B
int
foo(int arg)
{
	/* code */
}








int
bar(int arg)
{



	/* changed code */
}
EOF
bk diff -up A B > WANT
bk ndiff -up A B > GOT
cmp -s WANT GOT || {
	dumpdiffs
	fail
}
echo OK

echo $N Test -b option...............................................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("this is a line\n");
	printf("this is a line\n");
	printf("this is a line\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("this is a line\n");
	if (foo) {
		printf("this is a line\n");
	}
	printf("this is a line\n");
}
EOF
cat <<EOF >WANT
4a5
> 	if (foo) {
5a7
> 	}
EOF
bk ndiff -b A B > GOT
cmpfiles WANT GOT
echo OK

echo $N Test -w option...............................................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("this is a line\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("this is aline\n");
}
EOF
cat <<EOF > WANT
4c4
< 	printf("this is a line\n");
---
> 	printf("this is aline\n");
EOF
bk ndiff -b A B > GOT
cmpfiles WANT GOT
bk ndiff -w A B > GOT
rm -f WANT
touch WANT
cmpfiles WANT GOT
echo OK

echo $N Test a diff -p cornercase....................................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("this is a line\n");
}

int
findcmd(int ac, char **av)
{
	int	i;

	if (ac == 0) return (-1);
	for (i = 0; cmds[i].name; ++i) {
		if (strcasecmp(av[0], cmds[i].name) == 0) {
			if (streq(av[0], "pull")) av[0] = "remote pull";
		}
	}
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("this is a line\n");
}

int
findcmd(int ac, char **av)
{
	int	i;
	av0 = av[0];

	if (ac == 0) return (-1);
	for (i = 0; cmds[i].name; ++i) {
		if (strcasecmp(av[0], cmds[i].name) == 0) {
			if (streq(av[0], "pull")) av[0] = "remote pull";
		}
	}
}
EOF
bk ndiff -up A B | sed -e 's/^--- A.*/--- A/g' -e 's/^+++ B.*/+++ B/g' > GOT
cat <<EOF > WANT
--- A
+++ B
@@ -8,6 +8,7 @@ findcmd(int ac, char **av)
 findcmd(int ac, char **av)
 {
 	int	i;
+	av0 = av[0];
 
 	if (ac == 0) return (-1);
 	for (i = 0; cmds[i].name; ++i) {
EOF
cmpfiles WANT GOT
echo OK

echo $N Test diff -p with function in context........................$NL
run_test() {
	FUNCTION=$1
	WANT=$2
	cat <<EOF > A
int
main(int ac, char **av)
{
	printf("this is a line\n");
}

EOF
	printf "$FUNCTION\n" >> A
	cat <<EOF >> A
{

	if (ac == 0) return (-1);
 label:	function(args);
	for (i = 0; cmds[i].name; ++i) {
		if (strcasecmp(av[0], cmds[i].name) == 0) {
			if (streq(av[0], "pull")) av[0] = "remote pull";
		}
	}
}
EOF
	cat <<EOF > B
int
main(int ac, char **av)
{
	printf("this is a line\n");
}

EOF
	printf "$FUNCTION\n" >> B
	cat <<EOF >> B
{

	if (ac == 0) return (-1);
 label:	function(args);
	for (i = 0; cmds[i].name; ++i) {
		if (strcasecmp(av[0], cmds[i].name) == 0) {
			if (streq(av[0], "pull")) av[0] = "remote pull";
		}
	}
	av0 = av[0];
}
EOF
	bk ndiff -u0p A B | grep -v ^--- | grep -v ^+++ > GOT1
	perl -ne 'if (/^@@.*@@ (.*)$/) {print "@@ $1\n";} else {print}' < GOT1 > GOT
	cat <<EOF > WANT
@@ $WANT
+	av0 = av[0];
EOF
	cmpfiles WANT GOT
}

run_test "int\nfindcmd(int ac, char **av)" "findcmd(int ac, char **av)"
run_test "int findcmd(int ac, char **av)" "int findcmd(int ac, char **av)"
run_test "static int findcmd(int ac, char **av)" "static int findcmd(int ac, char **av)"
run_test "void\nScan::complete (const Status scanStatus, const utf::SlightlyEmbarrassinglyButAlphanumericallyNamedString &errorString)" "Scan::complete (const Status scanStatus,"
run_test "void Scan::complete (const Status scanStatus, const utf::SlightlyEmbarrassinglyButAlphanumericallyNamedString &errorString)" "void Scan::complete (const Status scanSt"
run_test "static void Scan::complete (const Status scanStatus, const utf::SlightlyEmbarrassinglyButAlphanumericallyNamedString &errorString)" "static void Scan::complete (const Status"
run_test "Region::element_iterator Region::element_begin()" "Region::element_iterator Region::element"
# invalid ones should match main
run_test "(void)funcall();" "main(int ac, char **av)"
echo OK

echo $N Test C function alignment....................................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("This is main\n");
}

int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("This is main\n");
}

int
bfunc(int b)
{
	printf("This is bfunc\n");
}

int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > WANT
6a7,12
> int
> bfunc(int b)
> {
> 	printf("This is bfunc\n");
> }
> 
EOF
bk ndiff A B > GOT
cmpfiles WANT GOT
echo OK

echo $N Test adding a function with no space below...................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("This is main\n");
}

int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("This is main\n");
}

int
bfunc(int b)
{
	printf("This is bfunc\n");
}
int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > WANT
6a7,11
> int
> bfunc(int b)
> {
> 	printf("This is bfunc\n");
> }
EOF
bk ndiff A B > GOT
cmpfiles WANT GOT
echo OK

echo $N Test adding a function with no space above...................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("This is main\n");
}

int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("This is main\n");
}
int
bfunc(int b)
{
	printf("This is bfunc\n");
}

int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > WANT
5a6,10
> int
> bfunc(int b)
> {
> 	printf("This is bfunc\n");
> }
EOF
bk ndiff A B > GOT
cmpfiles WANT GOT
echo OK

echo $N Add a function that overlaps in comments.....................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("This is main\n");
}

/*
 * this is function afunc
 */
int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("This is main\n");
}

/*
 * this is function bfunc
 */
int
bfunc(int b)
{
	printf("This is bfunc\n");
}

/*
 * this is function afunc
 */
int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > WANT
6a7,15
> /*
>  * this is function bfunc
>  */
> int
> bfunc(int b)
> {
> 	printf("This is bfunc\n");
> }
> 
EOF
bk ndiff A B > GOT
cmpfiles WANT GOT
echo OK

echo $N Add a function with comments, no space.......................$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("This is main\n");
}

/*
 * this is function afunc
 */
int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("This is main\n");
}

/*
 * this is function bfunc
 */
int
bfunc(int b)
{
	printf("This is bfunc\n");
}
/*
 * this is function afunc
 */
int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > WANT
6a7,14
> /*
>  * this is function bfunc
>  */
> int
> bfunc(int b)
> {
> 	printf("This is bfunc\n");
> }
EOF
bk ndiff A B > GOT
cmpfiles WANT GOT
echo OK

echo $N Do a unified diff where the context overlaps.................$NL
rm -f A
i=1
while [ $i -le 100 ]
do
	echo $i >> A
	i=`expr $i + 1`
done
cat A | sed 's/^10$/A/;s/^18$/B/;' > B
bk --trace=tmp ndiff -up A B | grep -v ^--- | grep -v ^+++ > GOT
cat <<EOF > WANT
@@ -7,15 +7,15 @@ 
 7
 8
 9
-10
+A
 11
 12
 13
 14
 15
 16
 17
-18
+B
 19
 20
 21
EOF
cmpfiles WANT GOT
echo OK

echo $N Add a line at end of function and a new function.............$NL
cat <<EOF > A
int
main(int ac, char **av)
{
	printf("This is main\n");
}

int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
cat <<EOF > B
int
main(int ac, char **av)
{
	printf("This is main\n");
	return (0);
}

void
newfunc(void)
{
	printf("new function\n");
}

int
afunc(int a)
{
	printf("this is afunc\n");
}
EOF
# Desire something like:
# 4a5,6
# > 	return (0);
# > 6a8,13
# > void
# > newfunc(void)
# > {
# >  	printf("new function\n");
# > }
# > 
cat <<EOF > WANT
4a5,11
> 	return (0);
> }
> 
> void
> newfunc(void)
> {
> 	printf("new function\n");
EOF
bk ndiff A B > GOT
cmpfiles WANT GOT
echo failed \(bug align\)

echo $N Test alignment of lines within diff blocks in sdiff..........$NL
cat <<EOF > A
badger
mushroom
badger
EOF
cat <<EOF > B
badger
if (a snake)
  mushroom
endif
badger
EOF
bk ndiff --sdiff=1 A B > GOT
cat <<EOF > WANT
 
>
|
>
 
EOF
cmpfiles WANT GOT
echo OK
