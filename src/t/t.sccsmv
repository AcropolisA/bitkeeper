# This file is part of the BitKeeper Regression test suite.
# All of the files in this directory are Copyright (c) 2000 BitMover, Inc.
# and are not licensed under the terms of the BKL (BitKeeper License).
# Standard copyright law applies.
# 
# Redistribution in modified form is prohibited with one exception:
#    proposed modifications may be sent back to dev@bitmover.com for
#    possible inclusion in future releases.  Sending such modifications
#    constitutes your permission for BitMover, Inc. to distribute  the
#    modifications under any license.

# Copyright (c) 1999 Larry McVoy
# %K%

bk cset -i -s .
echo $N Test sccsmv w/ p locked file ................................$NL
rm -rf A B C D
mkdir A B D E
echo "This is file 1" > A/file1
echo "This is file 2" > B/file2
echo "This is file 3" > A/file3
echo "This is file 4" > A/file4
echo "This is file 4" > B/file4
echo "This is file 5" > D/file5
bk ci $Q -i -l A/file1 B/file2 A/file3 A/file4 B/file4 D/file5
for i in 2 3 4
do
	echo "This is file 1, rev 1.$i" > A/file1
	echo "This is file 2, rev 1.$i" > B/file2
	echo "This is file 3, rev 1.$i" > A/file3
	echo "This is file 4, rev 1.$i" > A/file4
	echo "This is file 4, rev 1.$i" > B/file4
	echo "This is file 5, rev 1.$i" > D/file5
	bk ci $Q -yrev1.$i -l A/file1 B/file2 A/file3 A/file4 B/file4 D/file5
done
bk sfiles -l A B | bk clean -
bk co $Q -l -r1.2  A/file1
bk mv A/file1 B/file1
# The file should have been moved, but not checked in.
if [ ! -f B/file1 ]; then echo failed; exit 1; fi
if [ ! -f B/SCCS/s.file1 ]; then echo failed; exit 1; fi
if [ ! -f B/SCCS/p.file1 ]; then echo failed; exit 1; fi
if [ ! -f A/SCCS/s.file3 ]; then echo failed; exit 1; fi
DPATH=`bk prs -hr1.2.1.1 -d:DPN: B/file1`
if [ ${DPATH}X != ""X ]; then echo failed; exit 1; fi
# Now check it in so later tests aren't confused.
bk ci $Q -yrename B/file1
echo OK
echo $N Test sccsmv w/ unlocked file ................................$NL
bk mv B/file2 C/file3
if [ -f C/file3 ]; then echo failed; exit 1; fi
if [ ! -f C/SCCS/s.file3 ]; then echo failed; exit 1; fi
if [ -f C/SCCS/p.file3 ]; then echo failed; exit 1; fi
DPATH=`bk prs -hr+ -d:DPN: C/file3`
if [ ${DPATH}X != "C/file3"X ]; then echo failed; exit 1; fi
DPATH=`bk prs -hr1.1 -d:DPN: C/file3`
if [ ${DPATH}X != "B/file2"X ]; then echo failed; exit 1; fi
echo OK
echo $N Test sccsmv to directory ....................................$NL
bk mv B/file1 B/file4 C
if [ ! -f C/SCCS/s.file1 ]; then echo failed; exit 1; fi
if [ ! -f C/SCCS/s.file4 ]; then echo failed; exit 1; fi
if [ -d B ]; then echo failed; exit 1; fi
mkdir B
bk mv C/file1 C/file4 B
if [ ! -d C ]; then echo failed; exit 1; fi
echo OK
echo $N Test sccsrm w/ p locked file ................................$NL
bk get $Q -e B/file1
bk sccsrm B/file1
if [ -f B/SCCS/p..del-file1 ]; then echo failed 1; exit 1; fi
if [ ! -f B/SCCS/s..del-file1 ]; then echo failed 2; exit 1; fi
REV=`bk prs -hr+ -d:I: B/.del-file1`
if [ ${REV}X != "1.7"X ]; then echo failed 3 $REV; exit 1; fi
echo OK
echo $N Test sccsrm w non p-locked file .............................$NL
bk sccsrm C/file3
if [ -f C/SCCS/p..del-file3 ]; then echo failed; exit 1; fi
if [ ! -f C/SCCS/s..del-file3 ]; then echo failed; exit 1; fi
DPATH=`bk prs -hr+ -d:DPN: C/.del-file3`
if [ ${DPATH}X != "C/.del-file3"X ]; then echo failed; exit 1; fi
echo OK
echo $N Check implied file lists for rm-ed files ....................$NL
cd C
bk co $Q
if [ -f .del-file3 ]; then echo Failed - file was gotten; exit 1; fi
echo OK
echo $N Explicitly get a removed file ...............................$NL
bk co $Q .del-file3
if [ ! -f .del-file3 ]; then echo Failed to get file; exit 1; fi
echo OK
echo $N Clean all including rm-ed file ..............................$NL
bk clean
if [ -f .del-file3 ]; then echo Failed to clean file; exit 1; fi
echo OK
cd ..
echo $N Test sccsrm w/ -d option ....................................$NL
# this directory should be created by "bk setup"
mkdir -p BitKeeper/deleted/SCCS
bk clean A
#bk sccsrm -d A/file3
bk rm A/file3
DDIR=BitKeeper/deleted
if [ ! -f ${DDIR}/SCCS/s..del-file3 ]; then echo failed; exit 1; fi
if [ -f ${DDIR}/SCCS/p..del-file3 ]; then echo failed; exit 1; fi
DPATH=`bk prs -hr+ -d:DPN: ${DDIR}/.del-file3`
if [ ${DPATH}X != "${DDIR}/.del-file3"X ]; then echo failed; exit 1; fi
echo OK
echo $N Test sccsrm w/ -d \& p locked file ...........................$NL
bk get $Q -e A/file4
REV=`bk prs -hr+ -d:I: A/file4`
#bk sccsrm -d A/file4
bk rm A/file4
if [ ! -f ${DDIR}/SCCS/s..del-file4 ]; then echo failed; exit 1; fi
if [ -f ${DDIR}/SCCS/p..del-file4 ]; then echo failed; exit 1; fi
REV=`bk prs -hr+ -d:I: ${DDIR}/.del-file4`
if [ ${REV}X != "1.5"X ]; then echo failed; exit 1; fi
DPATH=`bk prs -hr+ -d:DPN: ${DDIR}/.del-file4`
if [ ${DPATH}X != "${DDIR}/.del-file4"X ]; then echo failed; exit 1; fi
echo OK
echo $N Test sccsrm w/ -d \& duplicate name ..........................$NL
#bk sccsrm -d B/file4
bk rm B/file4
if [ ! -f ${DDIR}/SCCS/s..del-file4~1 ]; then echo failed; exit 1; fi
REV=`bk prs -hr+ -d:I: ${DDIR}/.del-file4~1`
if [ ${REV}X != "1.7"X ]; then echo failed; exit 1; fi
DPATH=`bk prs -hr+ -d:DPN: ${DDIR}/.del-file4~1`
if [ ${DPATH}X != "${DDIR}/.del-file4~1"X ]; then echo failed; exit 1; fi
echo OK
echo $N Test sccsrm \& empty directory ...............................$NL
HERE=`pwd`
cd D
bk sccsrm -d file5 || { echo failed.; exit 1; }
if [ -d SCCS ]; then echo fail to remove empty SCCS; exit 1; fi
echo OK
cd ..
echo $N Test sccsmv to directory that does not exist ................$NL
date > C/file6
bk new $Q C/file6
bk mv C CCCC
if [ ! -f CCCC/SCCS/s.file6 ]
then	echo failed to move file; exit 1
fi
if [ ! -f CCCC/SCCS/s..del-file3 ]
then	echo failed to move deleted file; exit 1
fi
echo OK
echo $N Edit G, rm G, bk mv G, should create rm delta ...............$NL
date > G
bk new $Q G
cp SCCS/s.G S.G
bk edit $Q G
${RM} -f G
bk rm G 2> $DEV_NULL
cmp -s S.G SCCS/s..del-G
if [ $? = 0 ]; then echo Failed to add rm delta; exit 1; fi
if [ -f p.G ]; then echo Failed to rm p.G; exit 1; fi
if [ -f p..del-G ]; then echo Failed to rm p..del-G; exit 1; fi
echo OK
